{"metadata":{},"options":{"plugins":[{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"base$0$2","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"polyfill":false,"useBuiltIns":false}},{"key":"base$0$3","visitor":{"_exploded":{},"_verified":{},"PrivateName":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$4","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$5","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$6","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"base$0$1$0","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"base$0$1$1","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$1","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$2","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$3","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$4","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$5","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$6","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$7","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$8","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$9","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$10","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$11","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]}},"options":{}},{"key":"base$0$0$12","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$13","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$14","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$15","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$16","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]}},"options":{}},{"key":"base$0$0$17","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$18","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$19","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$20","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$21","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"base$0$0$22","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$23","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]}},"options":{}}],"presets":[],"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"C:\\Users\\wayne\\src\\kwaiette\\tmp\\padawan\\packages\\jagi:astronomy\\lib\\modules\\storage\\utils\\getModified.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining","pipelineOperator","throwExpressions","dynamicImport","classProperties","classPrivateProperties","jsx",["flow",{}],"asyncGenerators","objectRestSpread","objectRestSpread",["flow",{}],"asyncGenerators"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"sourceFileName":"packages/jagi:astronomy/lib/modules/storage/utils/getModified.js","filename":"C:\\Users\\wayne\\src\\kwaiette\\tmp\\padawan\\packages\\jagi:astronomy\\lib\\modules\\storage\\utils\\getModified.js","passPerPreset":false,"envName":"development","cwd":"C:\\Users\\wayne\\src\\kwaiette\\tmp\\padawan","root":"C:\\Users\\wayne\\src\\kwaiette\\tmp\\padawan","generatorOpts":{"filename":"C:\\Users\\wayne\\src\\kwaiette\\tmp\\padawan\\packages\\jagi:astronomy\\lib\\modules\\storage\\utils\\getModified.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/jagi:astronomy/lib/modules/storage/utils/getModified.js"}},"code":"var _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _objectSpread2 = _interopRequireDefault(require(\"@babel/runtime/helpers/objectSpread\"));\n\nvar module1 = module;\n\nvar _each;\n\nmodule1.watch(require(\"lodash/each\"), {\n  \"default\": function (v) {\n    _each = v;\n  }\n}, 0);\n\nvar _isPlainObject;\n\nmodule1.watch(require(\"lodash/isPlainObject\"), {\n  \"default\": function (v) {\n    _isPlainObject = v;\n  }\n}, 1);\n\nvar _range;\n\nmodule1.watch(require(\"lodash/range\"), {\n  \"default\": function (v) {\n    _range = v;\n  }\n}, 2);\nvar EJSON;\nmodule1.watch(require(\"meteor/ejson\"), {\n  EJSON: function (v) {\n    EJSON = v;\n  }\n}, 3);\nvar throwParseError;\nmodule1.watch(require(\"../../core/utils/throw_parse_error.js\"), {\n  \"default\": function (v) {\n    throwParseError = v;\n  }\n}, 4);\nvar rawMany;\nmodule1.watch(require(\"../../fields/utils/rawMany\"), {\n  \"default\": function (v) {\n    rawMany = v;\n  }\n}, 5);\nvar diff;\nmodule1.watch(require(\"./diff\"), {\n  \"default\": function (v) {\n    diff = v;\n  }\n}, 6);\nvar handlers = {};\n\nhandlers.onDiff = function (_ref) {\n  var prefix = _ref.prefix,\n      result = _ref.result;\n  result.push(prefix);\n};\n\nhandlers.onObjectDiff = function (_ref2) {\n  var oldDoc = _ref2.oldDoc,\n      newDoc = _ref2.newDoc,\n      prefix = _ref2.prefix,\n      result = _ref2.result;\n  diff((0, _objectSpread2.default)({\n    oldDoc: oldDoc,\n    newDoc: newDoc,\n    prefix: prefix,\n    result: result\n  }, handlers));\n};\n\nhandlers.onListDiff = function (_ref3) {\n  var oldList = _ref3.oldList,\n      newList = _ref3.newList,\n      prefix = _ref3.prefix,\n      result = _ref3.result;\n  var maxLength = Math.max(oldList.length, newList.length);\n\n  _each(_range(maxLength), function (index) {\n    var arrayPrefix = prefix + \".\" + index;\n    var oldElement = oldList[index];\n    var newElement = newList[index];\n\n    if (!EJSON.equals(oldElement, newElement)) {\n      result.push(arrayPrefix); // If both array elements are object, then we perform diff between\n      // them.\n\n      if (_isPlainObject(oldElement) && _isPlainObject(newElement)) {\n        // Get a difference between elements.\n        diff((0, _objectSpread2.default)({\n          oldDoc: oldElement,\n          newDoc: newElement,\n          prefix: arrayPrefix,\n          result: result\n        }, handlers));\n      }\n    }\n  });\n};\n\nfunction getModified() {\n  var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n  var newDoc = options.doc,\n      _options$transient = options.transient,\n      transient = _options$transient === void 0 ? false : _options$transient,\n      _options$immutable = options.immutable,\n      immutable = _options$immutable === void 0 ? false : _options$immutable,\n      fields = options.fields;\n  var Class = newDoc.constructor;\n  var opts = {\n    defaults: false\n  };\n  var oldDoc = Class.findOne(newDoc._id, opts);\n\n  if (!oldDoc) {\n    oldDoc = new Class({}, opts);\n  } // If there is no document before modifications that may mean that we are not\n  // subscribed to the publication publishing given document or we modified the\n  // _id of a document.\n\n\n  if (!oldDoc) {\n    throwParseError([{\n      'module': 'storage'\n    }, {\n      'utility': 'getModified'\n    }, \"Can not get a document before modifications. You are not subscribed \" + (\"to the publication publishing a \\\"\" + Class.getName() + \"\\\" document with \") + (\"the id \\\"\" + newDoc._id + \"\\\" or you have modified the \\\"_id\\\" field\")]);\n  } // If there are not fields specified, then get all of them.\n\n\n  if (!fields) {\n    fields = Class.getFieldsNames();\n  }\n\n  var result = [];\n  diff((0, _objectSpread2.default)({\n    // Get raw data from the docs.\n    oldDoc: rawMany(oldDoc, fields, {\n      \"transient\": transient,\n      immutable: immutable,\n      undefined: false\n    }),\n    newDoc: rawMany(newDoc, fields, {\n      \"transient\": transient,\n      immutable: immutable,\n      undefined: false\n    }),\n    result: result\n  }, handlers));\n  return result;\n}\n\n;\nmodule1.exportDefault(getModified);","map":{"version":3,"sources":["packages/jagi:astronomy/lib/modules/storage/utils/getModified.js"],"names":["module1","module","_each","watch","require","v","_isPlainObject","_range","EJSON","throwParseError","rawMany","diff","handlers","onDiff","prefix","result","push","onObjectDiff","oldDoc","newDoc","onListDiff","oldList","newList","maxLength","Math","max","length","index","arrayPrefix","oldElement","newElement","equals","getModified","options","doc","transient","immutable","fields","Class","constructor","opts","defaults","findOne","_id","getName","getFieldsNames","undefined","exportDefault"],"mappings":"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","sourcesContent":["import _each from 'lodash/each';\nimport _isPlainObject from 'lodash/isPlainObject';\nimport _range from 'lodash/range';\nimport { EJSON } from 'meteor/ejson';\nimport throwParseError from '../../core/utils/throw_parse_error.js';\nimport rawMany from '../../fields/utils/rawMany';\nimport diff from './diff';\n\nconst handlers = {};\n\nhandlers.onDiff = function({prefix, result}) {\n  result.push(prefix);\n};\n\nhandlers.onObjectDiff = function({oldDoc, newDoc, prefix, result}) {\n  diff({\n    oldDoc,\n    newDoc,\n    prefix,\n    result,\n    ...handlers\n  });\n};\n\nhandlers.onListDiff = function({oldList, newList, prefix, result}) {\n  const maxLength = Math.max(oldList.length, newList.length);\n  _each(_range(maxLength), function(index) {\n    const arrayPrefix = `${prefix}.${index}`;\n    const oldElement = oldList[index];\n    const newElement = newList[index];\n    if (!EJSON.equals(oldElement, newElement)) {\n      result.push(arrayPrefix);\n      // If both array elements are object, then we perform diff between\n      // them.\n      if (_isPlainObject(oldElement) && _isPlainObject(newElement)) {\n        // Get a difference between elements.\n        diff({\n          oldDoc: oldElement,\n          newDoc: newElement,\n          prefix: arrayPrefix,\n          result,\n          ...handlers\n        });\n      }\n    }\n  });\n};\n\nfunction getModified(options = {}) {\n  let {\n    doc: newDoc,\n    transient = false,\n    immutable = false,\n    fields\n  } = options;\n\n  const Class = newDoc.constructor;\n  const opts = {\n    defaults: false\n  };\n  let oldDoc = Class.findOne(newDoc._id, opts);\n  if (!oldDoc) {\n    oldDoc = new Class({}, opts);\n  }\n  // If there is no document before modifications that may mean that we are not\n  // subscribed to the publication publishing given document or we modified the\n  // _id of a document.\n  if (!oldDoc) {\n    throwParseError([{\n        'module': 'storage'\n      }, {\n        'utility': 'getModified'\n      },\n      `Can not get a document before modifications. You are not subscribed ` +\n      `to the publication publishing a \"${Class.getName()}\" document with ` +\n      `the id \"${newDoc._id}\" or you have modified the \"_id\" field`\n    ]);\n  }\n\n  // If there are not fields specified, then get all of them.\n  if (!fields) {\n    fields = Class.getFieldsNames();\n  }\n\n  const result = [];\n  diff({\n    // Get raw data from the docs.\n    oldDoc: rawMany(oldDoc, fields, {\n      transient,\n      immutable,\n      undefined: false\n    }),\n    newDoc: rawMany(newDoc, fields, {\n      transient,\n      immutable,\n      undefined: false\n    }),\n    result,\n    ...handlers\n  });\n  return result;\n};\n\nexport default getModified;"]},"sourceType":"script","hash":"c7739aab335b0d8141c893d1e2d3beee582f6ef9"}
